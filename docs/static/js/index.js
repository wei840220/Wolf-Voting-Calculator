var app=new Vue({el:"#app",data:{timeData:[],aliveData:{},userData:[],voteData:{},showDead:!0,onFocus:{column:"",reverse:!1},currentTime:{},text:""},computed:{active:function(){return this.timeData.length}},methods:{insertData:function(){var t=this;try{var a=t._getDatafromString();t._isTimeRepeat(a.timeData.dt)||(t._appendUserData(a.userData),t._updateCurrentTime(a.timeData),t._appendTimeData(a.timeData),t._appendVoteData(a.voteData),t._updateAliveData(a.timeData.day,a.timeData.time,a.userData))}catch(t){swal("QQ，似乎有點問題","請再確認投票結果的複製格式是否正確")}finally{t.text=""}},_isTimeRepeat:function(t){for(var a=this,e=0;e<a.timeData.length;e++)if(a.timeData[e].dt==t)return!0;return!1},_updateCurrentTime:function(t){var a=this;a.currentTime.dt?a.currentTime.day<t.day?a.currentTime={day:t.day,time:t.time,dt:t.dt}:a.currentTime.day==t.day&&a.currentTime.time<t.time&&(a.currentTime={day:t.day,time:t.time,dt:t.dt}):a.currentTime={day:t.day,time:t.time,dt:t.dt}},_updateAliveData:function(t,a,e){var r=this;e.forEach(function(e){r.aliveData[e]?r.aliveData[e].day<t?r.aliveData[e]={day:t,time:a,dt:t+"-"+a}:r.aliveData[e].day==t&&r.aliveData[e].time<a&&(r.aliveData[e]={day:t,time:a,dt:t+"-"+a}):r.aliveData[e]={day:t,time:a,dt:t+"-"+a}})},_appendTimeData:function(t){var a=this;a.timeData.push(t),a.timeData.sort(a._compareByDayandTime())},_appendUserData:function(t){var a=this;if(0==a.userData.length)a.userData=t;else if(a.userData.length<t.length){var e=t.filter(function(t){return-1==a.userData.indexOf(t)});a.userData=a.userData.concat(e)}},_appendVoteData:function(t){if(t){var a=this;for(var e in t)a.voteData[e]?(a.voteData[e].push(t[e]),a.voteData[e].sort(a._compareByDayandTime())):a.voteData[e]=[t[e]]}},_compareByDayandTime:function(){return function(t,a){return t.day>a.day?1:t.day==a.day&&t.time>a.time?1:-1}},_getDatafromString:function(){var t=this,a=t.text.split("\n"),e=t._getDayAndTimefromString(a[0]),r=t._getVotesfromString(a.splice(1)),i={},n=[],o=Object.assign({show:!0},e);return r.forEach(function(t){var a={target:t.target,votes:t.votes,day:e.day,time:e.time};i[t.id]=a,n.push(t.id)}),{voteData:i,userData:n,timeData:o}},_getDayAndTimefromString:function(t){var a=t.split(" 日目 "),e=a[0],r=a[1].slice(2,a[1].indexOf(" 回目"));return{day:parseInt(e),time:parseInt(r),dt:e+"-"+r}},_getVotesfromString:function(t){var a=[];return t.forEach(function(t){var e=t.replace(/	/i," ").replace(/	/g," "),r=e.split(" ");r.indexOf("")>0&&r.splice(r.indexOf(""),1),""!=r[0]&&a.push({id:r[0],votes:parseInt(r[1]),target:r[r.length-1]})}),a},_getVoteDataByTime:function(t,a){var e=this,r=e.voteData,i=[];for(var n in r)for(var o=0;o<r[n].length;o++)if(r[n][o].day==t&&r[n][o].time==a){i.push({uid:n,votes:r[n][o].votes,target:r[n][o].target});break}return i},_compareByPropName:function(t){return function(t,a){var e=t.prop,r=a.prop;return e<r?-1:e>r?1:0}},_sortByProp:function(t){return function(a,e){return a[t]<e[t]?-1:a[t]>e[t]?1:0}},sortVoteDataByPropName:function(t,a,e){var r=this,i=[],n=t+"-"+a+"-"+e;if(r.onFocus.column==n&&0==r.onFocus.reverse){var o=r._getVoteDataByTime(t,a);o.sort(r._sortByProp(e)).reverse(),o.map(function(t){i.push(t.uid)});var u=r.userData.filter(function(t){return-1==i.indexOf(t)});i=i.concat(u),r.userData=i,r.onFocus.reverse=!r.onFocus.reverse}else{var o=r._getVoteDataByTime(t,a);o.sort(r._sortByProp(e)),o.map(function(t){i.push(t.uid)});var u=r.userData.filter(function(t){return-1==i.indexOf(t)});i=i.concat(u),r.userData=i,r.onFocus={column:n,reverse:!1}}},showHowToUse:function(){swal({title:"投票結果複製",text:"要包含幾日目第幾回一同複製",imageUrl:"static/images/votes.png",imageSize:"260x250"})}}});