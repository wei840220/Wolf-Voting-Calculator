var app=new Vue({el:"#app",data:{timeData:[],aliveData:{},userData:[],voteData:{},showDead:!0,onFocus:{column:"",reverse:!1},currentTime:{},text:""},computed:{active:function(){return this.timeData.length}},methods:{insertData:function(){var t=this;try{var e=t._getDatafromString();t._isTimeRepeat(e.timeData.dt)||(t._appendUserData(e.userData),t._updateCurrentTime(e.timeData),t._appendTimeData(e.timeData),t._appendVoteData(e.voteData),t._updateAliveData(e.timeData.day,e.timeData.time,e.userData))}catch(t){swal("QQ，似乎有點問題","請再確認投票結果的複製格式是否正確")}finally{t.text=""}},_isTimeRepeat:function(t){for(var e=this,a=0;a<e.timeData.length;a++)if(e.timeData[a].dt==t)return!0;return!1},_updateCurrentTime:function(t){var e=this;e.currentTime.dt?e.currentTime.day<t.day?e.currentTime={day:t.day,time:t.time,dt:t.dt}:e.currentTime.day==t.day&&e.currentTime.time<t.time&&(e.currentTime={day:t.day,time:t.time,dt:t.dt}):e.currentTime={day:t.day,time:t.time,dt:t.dt}},_updateAliveData:function(t,e,a){var r=this;a.forEach(function(a){r.aliveData[a]?r.aliveData[a].day<t?r.aliveData[a]={day:t,time:e,dt:t+"-"+e}:r.aliveData[a].day==t&&r.aliveData[a].time<e&&(r.aliveData[a]={day:t,time:e,dt:t+"-"+e}):r.aliveData[a]={day:t,time:e,dt:t+"-"+e}})},_appendTimeData:function(t){var e=this;e.timeData.push(t),e.timeData.sort(e._compareByDayandTime())},_appendUserData:function(t){var e=this;if(0==e.userData.length)e.userData=t;else if(e.userData.length<t.length){var a=t.filter(function(t){return-1==e.userData.indexOf(t)});e.userData=e.userData.concat(a)}},_appendVoteData:function(t){if(t){var e=this;for(var a in t)e.voteData[a]?(e.voteData[a].push(t[a]),e.voteData[a].sort(e._compareByDayandTime())):e.voteData[a]=[t[a]]}},_compareByDayandTime:function(){return function(t,e){return t.day>e.day?1:t.day==e.day&&t.time>e.time?1:-1}},_getDatafromString:function(){var t=this,e=t.text.split("\n"),a=t._getDayAndTimefromString(e[0]),r=t._getVotesfromString(e.splice(1)),i={},n=[],o=Object.assign({show:!0},a);return r.forEach(function(t){var e={target:t.target,votes:t.votes,day:a.day,time:a.time};i[t.id]=e,n.push(t.id)}),{voteData:i,userData:n,timeData:o}},_getDayAndTimefromString:function(t){var e=t.split(" 日目 "),a=e[0],r=e[1].slice(2,e[1].indexOf(" 回目"));return{day:parseInt(a),time:parseInt(r),dt:a+"-"+r}},_getVotesfromString:function(t){var e=[];return t.forEach(function(t){var a=t.replace(/	/i," ").replace(/	/g," "),r=a.split(" ");r.indexOf("")>0&&r.splice(r.indexOf(""),1),""!=r[0]&&e.push({id:r.slice(0,r.indexOf("投票給")-2).join(" "),votes:parseInt(r[r.indexOf("投票給")-2]),target:r.slice(r.indexOf("投票給")+4).join(" ")})}),e},_getVoteDataByTime:function(t,e){var a=this,r=a.voteData,i=[];for(var n in r)for(var o=0;o<r[n].length;o++)if(r[n][o].day==t&&r[n][o].time==e){i.push({uid:n,votes:r[n][o].votes,target:r[n][o].target});break}return i},_compareByPropName:function(t){return function(t,e){var a=t.prop,r=e.prop;return a<r?-1:a>r?1:0}},_sortByProp:function(t){return function(e,a){return e[t]<a[t]?-1:e[t]>a[t]?1:0}},sortVoteDataByPropName:function(t,e,a){var r=this,i=[],n=t+"-"+e+"-"+a;if(r.onFocus.column==n&&0==r.onFocus.reverse){var o=r._getVoteDataByTime(t,e);o.sort(r._sortByProp(a)).reverse(),o.map(function(t){i.push(t.uid)});var u=r.userData.filter(function(t){return-1==i.indexOf(t)});i=i.concat(u),r.userData=i,r.onFocus.reverse=!r.onFocus.reverse}else{var o=r._getVoteDataByTime(t,e);o.sort(r._sortByProp(a)),o.map(function(t){i.push(t.uid)});var u=r.userData.filter(function(t){return-1==i.indexOf(t)});i=i.concat(u),r.userData=i,r.onFocus={column:n,reverse:!1}}},showHowToUse:function(){swal({title:"投票結果複製",text:"要包含幾日目第幾回一同複製",imageUrl:"static/images/votes.png",imageSize:"260x250"})}}});